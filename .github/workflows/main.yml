name: Validate pull request

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]
    paths:
      - "force-app/**"

jobs:
  validate-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Install sf cli"
        run: npm install @salesforce/cli --global

      - name: "Install sfdx-scanner"
        run: sf plugins install @salesforce/sfdx-scanner

      - name: "Install sfdx-git-delta"
        run: echo y | sf plugins install sfdx-git-delta

      - name: "Authenticate using SFDX_AUTH_URL"
        run: echo ${{ secrets.SFDX_AUTH_URL }} | sf org login sfdx-url -s -a dev -u

      - name: "Scan code"
        run: sf scanner run -e pmd -t . --normalize-severity --severity-threshold 2

      - name: "Validate Build and Run Tests"
        run: |
          OUTPUT=$(sf sgd source delta --to "HEAD" --from "HEAD^" -o "." -i .forceignore 2>&1)
          if echo "$OUTPUT" | grep -q "Success"; then
            echo "Delta generation successful"
            echo "$OUTPUT"
          elif echo "$OUTPUT" | grep -q "No local changes to deploy."; then
            echo "No changes to deploy - continuing workflow"
            echo "$OUTPUT"
            exit 0
          else
            echo "Delta generation failed with an error"
            echo "$OUTPUT"
            exit 1
          fi
          sf project deploy validate -x package/package.xml -l RunLocalTests -w 30
